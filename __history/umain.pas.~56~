unit umain;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ComCtrls, Vcl.ExtCtrls,
  Vcl.Imaging.jpeg, System.ImageList, Vcl.ImgList, Vcl.Buttons, Vcl.Menus;

type
  TCharFormat2 = record
    cbSize: UINT;
    dwMask: DWORD;
    dwEffects: DWORD;
    yHeight: LongInt;
    yOffset: LongInt;
    crTextColor: COLORREF;
    bCharSet: Byte;
    bPitchAndFamily: Byte;
    szFaceName: array[0..LF_FACESIZE - 1] of Char;
    wWeight: Word;
    sSpacing: ShortInt;
    crBackColor: COLORREF;
    lcid: LongInt;
    dwReserved: DWORD;
    sStyle: ShortInt;
    wKerning: Word;
    bUnderlineType: Byte;
    bAnimation: Byte;
    bRevAuthor: Byte;
    bReserved1: Byte;
  end;
const
  CFM_BACKCOLOR = $04000000;
  SCF_SELECTION = $0001;
  EM_SETCHARFORMAT = WM_USER + 68;

type
  TForm8 = class(TForm)
    Tortuga: TSpeedButton;
    pnlCodigo: TPanel;
    Panel1: TPanel;
    Panel2: TPanel;
    mmoLINEAS: TRichEdit;
    btnAvanzar: TBitBtn;
    btnReset: TButton;
    edtLinea: TEdit;
    btnRepinta: TBitBtn;
    pnlClear: TPanel;
    MainMenu1: TMainMenu;
    Archivo1: TMenuItem;
    Editar1: TMenuItem;
    N1: TMenuItem;
    Acercade1: TMenuItem;
    Cortar1: TMenuItem;
    Cortar2: TMenuItem;
    Pegar1: TMenuItem;
    Nuevo1: TMenuItem;
    Nuevo2: TMenuItem;
    Guardar1: TMenuItem;
    Guardar2: TMenuItem;
    N2: TMenuItem;
    N3: TMenuItem;
    N4: TMenuItem;
    N5: TMenuItem;
    Dispositivo1: TMenuItem;
    DetectarDispositivo1: TMenuItem;
    Conectar1: TMenuItem;
    N6: TMenuItem;
    SeguimientoenLinea1: TMenuItem;
    mmoAUX: TMemo;
    LsX: TListBox;
    lsY: TListBox;
    lsPen: TListBox;
    lsColor: TListBox;
    SaveDialog1: TSaveDialog;
    OpenDialog1: TOpenDialog;
    btnEjecutaTodo: TBitBtn;
    TimerEjecuta: TTimer;
    procedure btnResetClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure btnAvanzarClick(Sender: TObject);
    procedure btnRepintaClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormShow(Sender: TObject);
    procedure N5Click(Sender: TObject);
    procedure Acercade1Click(Sender: TObject);
    procedure Nuevo1Click(Sender: TObject);
    procedure Guardar2Click(Sender: TObject);
    procedure N3Click(Sender: TObject);
    procedure Cortar1Click(Sender: TObject);
    procedure Cortar2Click(Sender: TObject);
    procedure Pegar1Click(Sender: TObject);
    procedure btnEjecutaTodoClick(Sender: TObject);
    procedure TimerEjecutaTimer(Sender: TObject);
  private
    { Private declarations }
    paso,angT,ancho,alto : integer;
    oldLinea : string;
    Farchivo : string;
    TurtleColor : TColor;
    TurtlePen : integer;
    procedure Linea(Canvas: TCanvas; X1, Y1, X2, Y2: Integer; Color: TColor; Grosor: Integer);
    procedure Circulo(Canvas: TCanvas; X, Y, Radio: Integer; Color: TColor; Grosor: Integer);
    procedure TrianguloRotado(Canvas: TCanvas; Xd, Yd, b, h: Integer; A: Double; Color: TColor; Grosor: Integer);
    procedure ResaltarLinea(RichEdit: TRichEdit; Linea: Integer; ColorTexto: TColor; Estilo: TFontStyles);
    procedure ResaltarLineaConFondo(RichEdit: TRichEdit; Linea: Integer; ColorFondo,ColorLetra: TColor);
    procedure DibujaTortuga;
    function ProcesaLinea( s : String):integer;
    function fXT:integer;
    function fYT:integer;
    function xOld(n:integer):integer;
    function yOld(n:integer):integer;
    procedure GuardaArchivo(nombre : string);
    function ExisteArchivo(nombre : string):boolean;
  public
    { Public declarations }
  end;

var
  Form8: TForm8;

implementation

uses Math,operadoresmini;

{$R *.dfm}

function cvX(x:integer):integer;
 begin
    result:=x+trunc(Form8.ancho/2) + Form8.pnlCodigo.Width ;
 end;

function cvY(Y:integer):integer;
 begin
    result:=trunc(Form8.alto/2)-y;
 end;


procedure TForm8.GuardaArchivo(nombre : string);
 begin
   if BuscaStr(nombre,':') then
     MMOLINEAS.Lines.SaveToFile(nombre)
   else
     MMOLINEAS.Lines.SaveToFile(WORKDIR+'\'+nombre);
 end;

procedure TForm8.Guardar2Click(Sender: TObject);
begin
  if savedialog1.Execute() then
   begin
      Farchivo:=savedialog1.FileName;
      if Uppercase(ExtractFileExt(Farchivo))<>'LOGO' then
        Farchivo:=Farchivo+'.logo';
      GuardaArchivo(Farchivo);
   end;
end;

function TForm8.ExisteArchivo(nombre : string):boolean;
 begin
   if BuscaStr(nombre,':') then
     result:=FileExists(nombre)
   else
     Result:=FileExists(WORKDIR+'\'+nombre);
 end;

function Ruta_Archivo(nombre : string):string;
 begin
   if BuscaStr(nombre,':') then
     result:=nombre
   else
     result:=WORKDIR+'\'+nombre;
 end;

procedure TForm8.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  if mmoLineas.Lines.Count>1 then
    GuardaArchivo(Farchivo);

  mmoAux.Clear;
  mmoAux.Lines.Add(FArchivo);
  mmoAux.Lines.SaveToFile(workdir+'\ultimo.dato');
end;

procedure TForm8.FormCreate(Sender: TObject);
begin
  angT:=0;
  paso:=10;
  angT:=0;

  ancho:=(width-pnlCodigo.Width);
  alto:=Height-20;
  workdir:=getCurrentDir;

  Farchivo:='codigo.logo';
end;

procedure TForm8.FormShow(Sender: TObject);
begin
 if mmolineas.Lines.Count=0 then
 if FileExists(workdir+'\ultimo.dato') then
  begin
    mmoLineas.Lines.LoadFromFile(workdir+'\ultimo.dato');
    FArchivo:=mmoLineas.Lines[0];
    if FArchivo='' then Farchivo:='codigo.logo';
  end;

 if ExisteArchivo(Farchivo) then
   mmoLineas.Lines.LoadFromFile(Ruta_Archivo(Farchivo));
end;

function TForm8.fXT:integer;
 begin
   result:=ValI( lsX.Items[lsX.Items.Count-1] );
 end;

function TForm8.fyT:integer;
 begin
   result:=ValI( lsy.Items[lsy.Items.Count-1] );
 end;

function TForm8.xOld(n:integer):integer;
 begin
   result:=ValI( lsX.Items[lsX.Items.Count-1+n] );
 end;

function TForm8.yOld(n:integer):integer;
 begin
   result:=ValI( lsy.Items[lsy.Items.Count-1+n] );
 end;


 procedure TForm8.DibujaTortuga;
 var aPic: TPicture;  angTOR : integer;
 begin

   Tortuga.left:=cvx(fXT  -16);
   Tortuga.top:=cvY(fYT  +16);

   angTOR:=angT;
   //if angt>360 then angT:=angT-360;
   if angTOR<0 then angTOR:=360+angTOR;

   try
    aPic:=TPicture.Create;
    aPic.LoadFromFile(workdir+'\imagenes\tortuga_'+StrI(angTOR)+'.bmp');
    Tortuga.Glyph.Assign(aPic.Bitmap);
   finally
    aPic.Free;
   end;
 end;

procedure TForm8.Linea(Canvas: TCanvas; X1, Y1, X2, Y2: Integer; Color: TColor; Grosor: Integer);
begin
  Canvas.Pen.Color := Color;
  Canvas.Pen.Width := Grosor;
  Canvas.MoveTo(cvX(X1), cvY(Y1));
  Canvas.LineTo(cvX(X2), cvY(Y2));
end;

procedure TForm8.N3Click(Sender: TObject);
begin
  if OpenDialog1.Execute() then
    begin
      Farchivo:=OpenDialog1.FileName;
      //if Uppercase(ExtractFileExt(Farchivo))<>'LOGO' then
      //  Farchivo:=Farchivo+'.logo';
      if FileExists(FArchivo) then
        mmoLineas.Lines.LoadFromFile(Farchivo);
    end;
end;

procedure TForm8.N5Click(Sender: TObject);
begin
  Close;
end;

procedure TForm8.Nuevo1Click(Sender: TObject);
begin
  Farchivo:='nuevo_archivo.logo';
  BtnResetClick(nil);
  mmoLineas.Clear;
end;

procedure TForm8.Circulo(Canvas: TCanvas; X, Y, Radio: Integer; Color: TColor; Grosor: Integer);
begin
  Canvas.Pen.Color := Color;
  Canvas.Pen.Width := Grosor;
  Canvas.Ellipse(cvX(X - Radio), cvY(Y - Radio), cvX(X) + Radio, cvY(Y + Radio));
end;



procedure TForm8.Cortar1Click(Sender: TObject);
begin
  mmoLineas.CutToClipboard;
end;

procedure TForm8.Cortar2Click(Sender: TObject);
begin
  mmoLineas.CopyToClipboard;
end;

procedure TForm8.TimerEjecutaTimer(Sender: TObject);
begin
  btnAvanzarClick(nil);
  if ValI(edtLinea.Text)>=mmoLineas.lines.count then
   begin
       btnEjecutaTodo.Caption:='Ejecuta Todo';
       btnReset.Enabled:=true;
       btnAvanzar.Enabled:=true;
       timerEjecuta.Enabled:=false;
   end;
end;

procedure TForm8.TrianguloRotado(Canvas: TCanvas; Xd, Yd, b, h: Integer; A: Double; Color: TColor; Grosor: Integer);
var
  Vertice1, Vertice2, Vertice3: TPoint;
  RadA: Double;
  CosA, SinA: Double;
  x,y : integer;
  function RotatePoint(const P: TPoint; Angle: Double): TPoint;
  var
    RX, RY: Integer;
  begin
    RX := Round(P.X * CosA - P.Y * SinA);
    RY := Round(P.X * SinA + P.Y * CosA);
    Result := Point(X + RX, Y + RY);
  end;
begin
  x:=cvX(Xd);
  y:=cvY(Yd);
  // Convertir el ángulo de grados a radianes
  RadA := DegToRad(A);
  CosA := Cos(RadA);
  SinA := Sin(RadA);
  // Definir los vértices del triángulo antes de la rotación
  Vertice1 := Point(-b div 2, h div 2);  // Vértice izquierdo
  Vertice2 := Point(b div 2, h div 2);   // Vértice derecho
  Vertice3 := Point(0, -h div 2);        // Vértice superior
  // Rotar los vértices alrededor del punto (X, Y)
  Vertice1 := RotatePoint(Vertice1, RadA);
  Vertice2 := RotatePoint(Vertice2, RadA);
  Vertice3 := RotatePoint(Vertice3, RadA);
  // Dibujar el triángulo
  Canvas.Pen.Color := Color;
  Canvas.Pen.Width := Grosor;
  Canvas.Polygon([Vertice1, Vertice2, Vertice3]);
end;


procedure TForm8.ResaltarLinea(RichEdit: TRichEdit; Linea: Integer; ColorTexto: TColor; Estilo: TFontStyles);
var
  Inicio, Longitud: Integer;
begin
  // Verificar que la línea sea válida
  if (Linea < 0) or (Linea >= RichEdit.Lines.Count) then Exit;
  // Obtener la posición de inicio de la línea
  Inicio := SendMessage(RichEdit.Handle, EM_LINEINDEX, Linea, 0);
  // Obtener la longitud de la línea
  Longitud := Length(RichEdit.Lines[Linea]);
  // Seleccionar la línea
  RichEdit.SelStart := Inicio;
  RichEdit.SelLength := Longitud;
  // Cambiar el color del texto y el estilo
  RichEdit.SelAttributes.Color := ColorTexto;
  RichEdit.SelAttributes.Style := Estilo;
  // Deseleccionar el texto para mostrar la selección resaltada
  RichEdit.SelStart := 0;
  RichEdit.SelLength := 0;
end;

procedure TForm8.ResaltarLineaConFondo(RichEdit: TRichEdit; Linea: Integer; ColorFondo,ColorLetra: TColor);
var
  Inicio, Longitud: Integer;
  CharFormat: TCharFormat2;
begin
  // Verificar que la línea sea válida
  if (Linea < 0) or (Linea >= RichEdit.Lines.Count) then Exit;
  // Obtener la posición de inicio de la línea
  Inicio := SendMessage(RichEdit.Handle, EM_LINEINDEX, Linea, 0);
  // Obtener la longitud de la línea
  Longitud := Length(RichEdit.Lines[Linea]);
  // Seleccionar la línea
  RichEdit.SelStart := Inicio;
  RichEdit.SelLength := Longitud;
  RichEdit.SelAttributes.Color := ColorLetra;
  // Configurar CHARFORMAT2 para el color de fondo
  ZeroMemory(@CharFormat, SizeOf(CharFormat));
  CharFormat.cbSize := SizeOf(CharFormat);
  CharFormat.dwMask := CFM_BACKCOLOR;
  CharFormat.crBackColor := ColorToRGB(ColorFondo);
  // Aplicar el formato de carácter
  SendMessage(RichEdit.Handle, EM_SETCHARFORMAT, SCF_SELECTION, LPARAM(@CharFormat));
  // Deseleccionar el texto para mostrar la selección resaltada
  RichEdit.SelStart := 0;
  RichEdit.SelLength := 0;
end;


procedure TForm8.Pegar1Click(Sender: TObject);
begin
  mmoLineas.PasteFromClipboard;
end;

function TForm8.ProcesaLinea( s : String):integer;
var orden : string;  valor : string;
    despY,despX:IntegeR;  I : INTEGER;
 begin

   orden:=SplitCadena(s,' ',1);
   valor:=SplitCadena(s,' ',2);

   if (orden='RT') or (orden='ROTATE_RIGHT') OR (orden='ROTAR_DERECHA')  then
     begin
       angT:=angT+ValI(valor);
       if angt>360 then angT:=angT-360;
       dibujaTortuga;
     end;


   if (orden='LT') or (orden='RL') or (orden='ROTATE_LEFT') OR (orden='ROTAR_IZQUIERDA') then
     begin
       angT:=angT-ValI(valor);
       if angt<0 then angT:=360+angT;
       dibujaTortuga;
     end;


   if (orden='FD') or (orden='FORWARD') OR (orden='AVANZAR')then
     begin
       despX:= trunc(cos( degToRad(angT) )*ValR(valor));
       despY:= trunc(sin( degToRad(angT) )*ValR(valor));

       lsX.Items.Add( StrI(fxt+despX) );
       lsY.Items.Add( StrI(fyt+despY) );

       lsColor.Items.Add(ColorToString(TurtleColor));
       lsPEN.Items.Add(StrI(TurtlePen));

       //showMessage(STrI(xold(-1))+'<>'+STrI(yold(-1)));
       //showMessage(STrI(fxt)+'<tt>'+STrI(fyt));
       dibujaTortuga;
       //Linea(Canvas,xold(-1),yold(-1),fxt,fyt,clblack,3);

     end;

   if (orden='COLOR') or (orden='COLOR') OR (orden='PINTAR') then
     BEGIN
        if (valor='BLACK') or (valor='NEGRO') THEN TurtleColor:=clBlack;
        if (valor='MAROON') or (valor='MARRON') THEN TurtleColor:=clMaroon;
        if (valor='GREEN') or (valor='VERDE') THEN TurtleColor:=clGreen;
        if (valor='OLIVE') or (valor='OLIVA') THEN TurtleColor:=clOlive;
        if (valor='NAVY') or (valor='NAVY') THEN TurtleColor:=clNavy;
        if (valor='PURPLE') or (valor='PURPLE') THEN TurtleColor:=clPurple;
        if (valor='TEAL') or (valor='VERDELIMA') THEN TurtleColor:=clTeal;
        if (valor='GRAY') or (valor='GRIS') THEN TurtleColor:=clGray;
        if (valor='SILVER') or (valor='PLATA') THEN TurtleColor:=clSilver;
        if (valor='RED') or (valor='ROJO') THEN TurtleColor:=clRed;
        if (valor='LIME') or (valor='CAL') THEN TurtleColor:=clLime;
        if (valor='YELLOW') or (valor='AMARILLO') THEN TurtleColor:=clYellow;
        if (valor='BLUE') or (valor='AZUL') THEN TurtleColor:=clBlue;
        if (valor='FUCHSIA') or (valor='FUCSIA') THEN TurtleColor:=clFuchsia;
        if (valor='AQUA') or (valor='AGUA') THEN TurtleColor:=clAqua;
        if (valor='WHITE') or (valor='BLANCO') THEN TurtleColor:=clWhite;
        if (valor='MONEYGREEN') or (valor='VERDECLARO') THEN TurtleColor:=clMoneyGreen;
        if (valor='SKYBLUE') or (valor='AZULCIELO') THEN TurtleColor:=clSkyBlue;
        if (valor='CREAM') or (valor='CREMA') THEN TurtleColor:=clCream;
        if (valor='MEDGRAY') or (valor='PLOMO') THEN TurtleColor:=clMedGray;
     END;

   if (orden='PEN') or (orden='LAPIZ') OR (orden='PLUMA') then
     BEGIN
        TurtlePen:=ValI(valor);
        if TurTlePen<0 then TurtlePen:=0;
     END;

   IF (LSx.Items.Count>1) AND (FALSE) then
    BEGIN  {
     for i:=0 to lsx.Items.Count-2 do
      Linea(Canvas,valI(lsX.Items[i]),valI(lsY.Items[i]),
            valI(lsX.Items[i+1]),valI(lsY.Items[i+1]),
            StringToColor(lsColor.Items[i]) ,//clblack,
            ValI(lsPEN.Items[i]));   }
    END;

    oldLinea:=S;

 end;

procedure TForm8.btnRepintaClick(Sender: TObject);
var i : integer;
begin
   IF (LSx.Items.Count>1) then
    BEGIN
     for i:=0 to lsx.Items.Count-2 do
      Linea(Canvas,valI(lsX.Items[i]),valI(lsY.Items[i]),
            valI(lsX.Items[i+1]),valI(lsY.Items[i+1]),
            StringToColor(lsColor.Items[i+1]) ,//clblack,
            ValI(lsPEN.Items[i+1]));
    END;
end;

procedure TForm8.Acercade1Click(Sender: TObject);
begin
  ShowMessage('Interprete Logo V0.3 por Hubel SB, archivo actual <'+FArchivo+'>');
end;

procedure TForm8.btnAvanzarClick(Sender: TObject);
begin

  if ValI(edtLinea.Text)<mmoLineas.Lines.Count then
   begin
     edtLinea.Text:=STrI( ValI(edtLinea.Text) + 1  );
     ResaltarLineaConFondo(mmoLineas,ValI(edtLinea.Text)-2,clWhite,clblack);
   end;

  ProcesaLinea(mmoLineas.Lines[ValI(edtLinea.Text)-1]);

  ResaltarLineaConFondo(mmoLineas,ValI(edtLinea.Text)-1,clYellow,clblack);

  repaint;
  update;
  btnRepintaClick(nil);

  //MEMO1.Lines.Add(STRi(ANGt));

end;

procedure TForm8.btnEjecutaTodoClick(Sender: TObject);
begin
  if TimerEjecuta.Enabled then
    begin
       btnEjecutaTodo.Caption:='Ejecuta Todo';
       btnReset.Enabled:=true;
       btnAvanzar.Enabled:=true;
       timerEjecuta.Enabled:=false;
    end
  else
    begin
       btnEjecutaTodo.Caption:='Detener...';
       btnReset.Enabled:=false;
       btnAvanzar.Enabled:=false;
       btnResetClick(nil);
       timerEjecuta.Enabled:=true;
    end;
end;

procedure TForm8.btnResetClick(Sender: TObject);
var
  i: Integer;
begin
  //ResaltarLinea(RichEdit1, 2, clwhite, [fsBold]);
  //ResaltarLineaConFondo(RichEdit1, 2, clYellow,clBlack);
  ancho:=(width-pnlCodigo.Width);
  alto:=Height-20;
  lsX.Clear;
  lsY.Clear;
  lsPen.Clear;
  lsColor.Clear;

  TurtlePen:=3;
  TurtleColor:=clBlack;

  lsX.Items.Add('0');
  lsY.Items.Add('0');
  lsColor.Items.Add('clBlack');
  lsPEN.Items.Add('3');

  angT:=0;
  edtLinea.Text:='0';
  for i := 0 to mmoLineas.Lines.Count-1 do
  ResaltarLineaConFondo(mmoLineas,i,clWhite,clblack);

  DibujaTortuga;

  {xt:=-100;
  Linea(Canvas,xold,yold,xt,yt,clblack,3);
  xold:=xt;
  yold:=yt;

  yt:=50;
  Linea(Canvas,xold,yold,xt,yt,clblack,3);
  xold:=xt;
  yold:=yt;}
  pnlclear.Visible:=true;
  sleep(200);
  pnlClear.Visible:=False;


end;

end.

